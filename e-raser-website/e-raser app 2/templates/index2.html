<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>E-raser</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style2.css') }}">
    </head>
    <body>
        <div class="container">
            <div id = "welcomeModal" class="modal">
                <div class="modal-content">
                    <h2>Welcome to E-raser!</h2>
                    <p> This is your smart vertical cleaner. Customize your setup to get started!</p>
                    <button class = "buttons" onclick="welcomeNext()">Next Page</button>
                </div>
            </div>

            <div id = "configModal" class="modal">
                <div class="modal-content">
                    <h2>Configure your cleaning area!</h2>
                    <p>Enter the size of your cleaning area:</p>
                    <div class="flex">
                        <input type="number" id="width" name="width">
                        <p>x</p>
                        <input type="number" id="height" name="height">
                        <select id="dimension">
                            <option value="in">IN</option>
                            <option value="cm">CM</option>
                        </select>
                    </div>
                    <button class = "buttons" onclick="configNext()">Next Page</button>
                </div>
            </div>
            
            <div id="takepicModal" class="modal">
                <div class="modal-content">
                    <h2>Configure your cleaning area!</h2>
                    <p>Take an picture of your cleaning area:</p>
                    <div class="image-wrap">
                        <img id="initial-webcam" src="{{ url_for('video_feed') }}" alt="Webcam Stream" />
                        <canvas id="initial-canvas"></canvas>
                    </div>
                    <div class="takepicbuttons">
                        <button class = "buttons" onclick="takePicture()">Take Picture</button>
                        <button class = "buttons" onclick="backToCam()">Go Back</button>
                    </div>
                    <button class = "buttons" onclick="afterTakePic()">Confirm Image</button>
                </div>
            </div>

            <div id="processpicModal" class="modal">
                <div class="modal-content">
                    <h2>Configure your cleaning area!</h2>
                    <p>Select your cleaning area:</p>
                    <div class="image-wrap">
                        <img id="area-image" src="static/saved_image.jpeg" alt="Webcam Stream" />
                        <canvas id="area-canvas"></canvas>
                    </div>
                    <button class = "buttons" onclick="processImage()">Detect Edges With AI</button>
                    <button class = "buttons" onclick="manualConfigure()">Manually Configure Cleaning Area</button>
                </div>  
            </div>

            <!--<div class="header">Welcome to E-raser</div>

            <div class="left">
                <div id="wb-specs">
                    <h3>WHITEBOARD SPECS *</h3>
                    <input type="number" id="width" name="width">
                    <p>by</p>
                    <input type="number" id="height" name="height">
                    <select id="height-dimension">
                        <option value="in">IN</option>
                        <option value="cm">CM</option>
                    </select>
                </div>

                <div class="space"></div>

                <div id="scheduling">
                    <h3>SCHEDULE</h3>
                    <label class="toggle-button">
                        <input type="checkbox" id="schedule-toggle" onchange="toggleScheduleFade()" checked>
                        <span class="slider"></span>
                    </label>
                    <p>Every</p>
                    <select id="amount">
                        <option value="one">1</option>
                        <option value="two">2</option>
                        <option value="three">3</option>
                        <option value="four">4</option>
                        <option value="five">5</option>
                        <option value="six">6</option>
                        <option value="seven">7</option>
                        <option value="eight">8</option>
                        <option value="nine">9</option>
                        <option value="ten">10</option>
                        <option value="eleven">11</option>
                        <option value="twelve">12</option>
                    </select>
                    <select id="time-unit">
                        <option value="hours">hours</option>
                        <option value="day" selected>days</option>
                        <option value="week">weeks</option>
                        <option value="month">months</option>
                    </select>
                    <p id = "at">at</p>
                    <select id="time-dropdown">
                        <option value="one">1</option>
                        <option value="two">2</option>
                        <option value="three">3</option>
                        <option value="four">4</option>
                        <option value="five">5</option>
                        <option value="six">6</option>
                        <option value="seven">7</option>
                        <option value="eight">8</option>
                        <option value="nine">9</option>
                        <option value="ten">10</option>
                        <option value="eleven">11</option>
                        <option value="twelve">12</option>
                    </select>
                    <p id = "colon">:</p>
                    <select id="minute-dropdown">
                        <option value="0">00</option>
                        <option value="1">01</option>
                        <option value="2">02</option>
                        <option value="3">03</option>
                        <option value="4">04</option>
                        <option value="5">05</option>
                        <option value="6">06</option>
                        <option value="7">07</option>
                        <option value="8">08</option>
                        <option value="9">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                        <option value="32">32</option>
                        <option value="33">33</option>
                        <option value="34">34</option>
                        <option value="35">35</option>
                        <option value="36">36</option>
                        <option value="37">37</option>
                        <option value="38">38</option>
                        <option value="39">39</option>
                        <option value="40">40</option>
                        <option value="41">41</option>
                        <option value="42">42</option>
                        <option value="43">43</option>
                        <option value="44">44</option>
                        <option value="45">45</option>
                        <option value="46">46</option>
                        <option value="47">47</option>
                        <option value="48">48</option>
                        <option value="49">49</option>
                        <option value="50">50</option>
                        <option value="51">51</option>
                        <option value="52">52</option>
                        <option value="53">53</option>
                        <option value="54">54</option>
                        <option value="55">55</option>
                        <option value="56">56</option>
                        <option value="57">57</option>
                        <option value="58">58</option>
                        <option value="59">59</option>
                    </select>
                    <select id="am-pm">
                        <option value="AM">AM</option>
                        <option value="PM">PM</option>
                    </select>
                    <button class = "buttons" onclick="sendSchedule()">Confirm</button>
                </div>
            </div>

            <div class="right">
                <h3>WHITEBOARD CAM</h3>
                <label class="toggle-button">
                    <input type="checkbox" id="cam-toggle" onchange="toggleCam()">
                    <span class="slider"></span>
                </label>
                <img id="webcam" src="{{ url_for('video_feed') }}" alt="Webcam Stream" />
                <canvas id="normal-canvas"></canvas>
                <button class="buttons">Clean all</button>
            </div>-->
        </div>
        <script>
            const welcomeModal = document.getElementById("welcomeModal");
            const configModal = document.getElementById("configModal");
            const takepicModal = document.getElementById("takepicModal"); 
            const processpicModal = document.getElementById("processpicModal"); 
    
            // const webcam = document.getElementById('webcam');
            // const webcam_canvas = document.getElementById('normal-canvas');
            // const webcam_ctx = webcam_canvas.getContext('2d');

            const init_webcam = document.getElementById('initial-webcam');
            const init_canvas = document.getElementById('initial-canvas');
            const init_ctx = init_canvas.getContext('2d');
            // let startX = 0, startY = 0, endX = 0, endY = 0, isDragging = false;
            // const camToggle = document.getElementById('cam-toggle').checked;
            
            const area_image = document.getElementById('area-image');
            const area_canvas = document.getElementById('area-canvas');
            const area_ctx = area_canvas.getContext('2d');

            let corner1 = [0,0], corner2 = [0,0], corner3 = [0,0], corner4 = [0,0]
            
            function resizeInitCanvasToImage() {
                const rect = init_webcam.getBoundingClientRect();
                init_canvas.height = rect.height;
                init_canvas.width = rect.width;
                init_canvas.style.height = rect.height + 'px';
                init_canvas.style.width = rect.width + 'px';
            }

            function resizeAreaCanvasToImage() {
                const rect = area_image.getBoundingClientRect();
                area_canvas.height = rect.height;
                area_canvas.width = rect.width;
                area_canvas.style.height = rect.height + 'px';
                area_canvas.style.width = rect.width + 'px';
            }

            window.onload = function() {
                /*webcam.src = '';
                webcam.style.display = 'none';
                webcam_canvas.style.display = 'none';*/
                init_webcam.src = '/video_feed';
                welcomeModal.style.display = 'flex';
                configModal.style.display = 'none';
                takepicModal.style.display = 'none';
                processpicModal.style.display = 'none';
            };

            function welcomeNext(){
                welcomeModal.style.display = 'none';
                configModal.style.display = 'flex';
                takepicModal.style.display = 'none';
                processpicModal.style.display = 'none';
            }

            function configNext(){
                const width = document.getElementById('width').value;
                const height = document.getElementById('height').value;
                const dimension = document.getElementById('dimension').value;

                fetch('/save_dimensions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        width: width,
                        height: height,
                        dimension: dimension
                    })
                })
                .then(response => {
                    if (response.ok) {
                        alert("sent successfully!")
                        
                        welcomeModal.style.display = 'none';
                        configModal.style.display = 'none';
                        takepicModal.style.display = 'flex';
                        processpicModal.style.display = 'none';
                        resizeInitCanvasToImage();
                    } else {
                        console.error("Failed to save image");
                    }
                });
            }

            function takePicture(){
                init_canvas.width = init_webcam.width;
                init_canvas.height = init_webcam.height;

                init_ctx.drawImage(init_webcam, 0, 0, init_canvas.width, init_canvas.height);

                const imageData = init_ctx.toDataURL('image/png');
            }

            function backToCam(){
                init_ctx.clearRect(0, 0, init_canvas.width, init_canvas.height);
            }

            async function afterTakePic(){
                const imageData = init_canvas.toDataURL('image/jpeg');
                fetch('/save_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageData })
                })
                .then(response => {
                    if (response.ok) {
                        alert("Image saved successfully");
                        resizeAreaCanvasToImage();
                        area_image.src = "static/saved_image.jpeg" + "?t=" + new Date().getTime(); ;

                        welcomeModal.style.display = 'none';
                        configModal.style.display = 'none';
                        takepicModal.style.display = 'none';
                        processpicModal.style.display = 'flex';
                    } else {
                        console.error("Failed to save image");
                    }
                });
            }
        
            function processImage(){
                fetch('/detect_board', {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        alert("Image processed successfully");
                        area_image.src = "static/edited_image.jpeg" + "?t=" + new Date().getTime();
                        area_image.onload = () => {
                            resizeAreaCanvasToImage();

                            welcomeModal.style.display = 'none';
                            configModal.style.display = 'none';
                            takepicModal.style.display = 'none';
                            processpicModal.style.display = 'flex';
                        }
                    } else {
                        console.error("Failed to save image");
                    }
                });
            }

            const clearAreaCanvas = () => area_ctx.clearRect(0, 0, area_canvas.width, area_canvas.height);
            
            let clickcount = 0;
            area_canvas.addEventListener('click', (e) => {
                resizeAreaCanvasToImage();
                rect = area_canvas.getBoundingClientRect()
                if (clickcount == 0){
                    area_ctx.beginPath();
                    corner1 = [e.clientX - rect.left, e.clientY - rect.top]
                    area_ctx.moveTo(corner1[0], corner1[1])
                    clickcount += 1;
                }
                else if (clickcount == 1){
                    corner2 = [e.clientX - rect.left, e.clientY - rect.top]
                    area_ctx.lineTo(corner2[0], corner2[1])
                    clickcount += 1;
                }
                else if (clickcount == 2){
                    corner3 = [e.clientX - rect.left, e.clientY - rect.top]
                    area_ctx.lineTo(corner3[0], corner3[1])
                    clickcount += 1;
                }
                else if (clickcount == 3){
                    corner4 = [e.clientX - rect.left, e.clientY - rect.top]
                    area_ctx.lineTo(corner4[0], corner4[1])
                    clickcount += 1;
                }
                else if (clickcount == 4){
                    clickcount = 1;
                    clearAreaCanvas()
                    area_ctx.beginPath();
                    corner1 = [e.clientX - rect.left, e.clientY - rect.top]
                }

                
            });

            function manualConfigure(){
                area_image.src = "static/saved_image.jpeg" + "?t=" + new Date().getTime();
                area_image.onload = () => {
                    resizeAreaCanvasToImage();

                    welcomeModal.style.display = 'none';
                    configModal.style.display = 'none';
                    takepicModal.style.display = 'none';
                    processpicModal.style.display = 'flex';
                }   
            }

            const clearCanvas = () => webcam_ctx.clearRect(0, 0, webcam_canvas.width, webcam_canvas.height);

            const drawBox = () => {
                clearCanvas();
                const width = endX - startX;
                const height = endY - startY;
                webcam_ctx.beginPath();
                webcam_ctx.rect(startX, startY, width, height);
                webcam_ctx.lineWidth = 3;
                webcam_ctx.strokeStyle = 'green';
                webcam_ctx.stroke();
                webcam_ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
                webcam_ctx.fill();
            };

            webcam.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = image.getBoundingClientRect();
                endX = e.clientX - rect.left;
                endY = e.clientY - rect.top;
                drawBox();
            });

            webcam.addEventListener('mouseup', () => isDragging = false);
/*
            function toggleScheduleFade(){
                const scheduleToggle = document.getElementById('schedule-toggle').checked;
                const scheduleTime = document.querySelector('.schedule-time');

                if (scheduleToggle) {
                    scheduleTime.classList.remove('faded');
                } else {
                    scheduleTime.classList.add('faded');
                }
            }

            function toggleTimeAndAmPm() {
                const unit = document.getElementById('time-unit').value;
                const timeDropdown = document.getElementById('time-dropdown');
                const ampmDropdown = document.getElementById('am-pm');
                const at_words = document.getElementById('at');
                const colon_word = document.getElementById('colon');
                const minDropdown = document.getElementById('minute-dropdown');

                if (unit === 'hours') {
                    timeDropdown.style.display = 'none';
                    ampmDropdown.style.display = 'none';
                    minDropdown.style.display = 'none';
                    at_words.style.display = 'none';
                    colon_word.style.display = 'none';
                } else {
                    timeDropdown.style.display = 'inline-block'; // or 'block' depending on layout
                    ampmDropdown.style.display = 'inline-block';
                    at_words.style.display = 'inline-block';
                    colon_word.style.display = 'inline-block';
                    minDropdown.style.display = 'inline-block';
                }
            }

            function sendSchedule(){
                
            }

            function toggleCam(){
                if (camToggle) {
                    webcam.src = '/video_feed';
                    webcam.style.display = 'block';
                    webcam_canvas.style.display = 'block';
                } else {
                    webcam.src = '';
                    webcam.style.display = 'none';
                    webcam_canvas.style.display = 'none';
                }
            }

            function resizeCanvasToImage() {
                const rect = webcam.getBoundingClientRect();
                webcam_canvas.width = rect.width;
                webcam_canvas.height = rect.height;
                webcam_canvas.style.width = rect.width + 'px';
                webcam_canvas.style.height = rect.height + 'px';
            }

            const clearCanvas = () => webcam_ctx.clearRect(0, 0, webcam_canvas.width, webcam_canvas.height);

            const drawBox = () => {
                clearCanvas();
                const width = endX - startX;
                const height = endY - startY;
                webcam_ctx.beginPath();
                webcam_ctx.rect(startX, startY, width, height);
                webcam_ctx.lineWidth = 3;
                webcam_ctx.strokeStyle = 'green';
                webcam_ctx.stroke();
                webcam_ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
                webcam_ctx.fill();
            };

            webcam.addEventListener('mousedown', (e) => {
                const rect = image.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                endX = startX;
                endY = startY;
                isDragging = true;
            });

            webcam.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = image.getBoundingClientRect();
                endX = e.clientX - rect.left;
                endY = e.clientY - rect.top;
                drawBox();
            });

            webcam.addEventListener('mouseup', () => isDragging = false);
            window.addEventListener('resize', resizeCanvasToImage);
            webcam.addEventListener('load', resizeCanvasToImage);
            webcam.onload = () => {
                resizeCanvasToImage();
            };
            document.getElementById('schedule-toggle').addEventListener('change', toggleScheduleFade);
            document.getElementById('time-unit').addEventListener('change', toggleTimeAndAmPm);
            
            toggleScheduleFade();
            toggleTimeAndAmPm();
            toggleCam();*/

        </script>
    </body>
</html>